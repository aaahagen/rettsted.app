rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if a user is signed in
    function isSignedIn() {
      return request.auth != null;
    }

    // Rules for the 'users' collection
    match /users/{userId} {
      // Allow a user to read and create their own document.
      allow read, create: if isSignedIn() && request.auth.uid == userId;
      // Disallow client-side updates and deletes for security.
      allow update, delete: if false;
    }

    // Rules for the 'organizations' collection
    match /organizations/{orgId} {
       // Allow a user to create their own organization document during registration.
       // The orgId MUST be the same as the user's UID.
      allow create: if isSignedIn() && request.auth.uid == orgId;
      
      // Allow a user to read the organization document if their custom claim matches.
      allow read: if isSignedIn() && request.auth.token.organizationId == orgId;

      // Only the owner of the organization can update it.
      allow update: if isSignedIn() && resource.data.ownerId == request.auth.uid;
      
      // Deletes are disallowed from the client.
      allow delete: if false;
    }

    // Rules for the 'locations' collection
    match /locations/{locationId} {
      // The user's organizationId custom claim must match the location's organizationId.
      function isMemberOfOrganization() {
        // For read operations, check the existing document's data.
        // For write operations, check the incoming document's data.
        return isSignedIn() && (
          (request.method in ['get', 'list'] && resource.data.organizationId == request.auth.token.organizationId) ||
          (request.method in ['create', 'update', 'delete'] && request.resource.data.organizationId == request.auth.token.organizationId)
        );
      }
      
      function isQueryingOwnOrganization() {
        return isSignedIn() && request.query.where.get('organizationId')[2] == request.auth.token.organizationId;
      }

      allow get, create, update, delete: if isMemberOfOrganization();
      allow list: if isQueryingOwnOrganization();
    }

    // A catch-all rule to deny all other access by default.
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
