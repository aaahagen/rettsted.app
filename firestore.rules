rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper Functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isUser(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // Checks if the user's custom claim matches the document's organizationId
    function isMemberOf(orgId) {
      return isSignedIn() && request.auth.token.organizationId == orgId;
    }

    // --- RULES ---

    // USERS collection
    match /users/{userId} {
      // A user can create their own document.
      // A user can read their own document.
      allow read, create: if isUser(userId);
      // No one can update or delete user profiles from the client.
      allow update, delete: if false;
    }

    // ORGANIZATIONS collection
    match /organizations/{orgId} {
      // A user can create an organization, but only if the orgId is their own UID.
      allow create: if isUser(orgId);
      // A user can read their own organization's document.
      allow read: if isMemberOf(orgId);
      // Only the organization owner can update its details.
      allow update: if isUser(resource.data.ownerId);
      // No one can delete an organization from the client.
      allow delete: if false;
    }

    // LOCATIONS collection
    match /locations/{locationId} {
      // To get a single location, user must be a member of that location's org.
      allow get: if isMemberOf(resource.data.organizationId);

      // To list locations, the query MUST be filtered by the user's organizationId.
      // This prevents listing locations from other orgs.
      allow list: if isSignedIn() && request.query.where.get('organizationId')[2] == request.auth.token.organizationId;
      
      // To create/update a location, user must be a member of the org they are writing to.
      allow create, update: if isMemberOf(request.resource.data.organizationId);

      // To delete a location, user must be a member of that location's org.
      allow delete: if isMemberOf(resource.data.organizationId);
    }
  }
}
